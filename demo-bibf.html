<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Bayanati â€” BIBF Data Enclave</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

    <style>
        :root {
            --bg: #0f1115;
            --panel: #0f1115;
            --panel-dark: #0b0d12;
            --accent: #60a5fa;
            --primary: #3b82f6;
            --grey: #8b93a7;
            --border: #252a3a;
            --text: #f5f7fa;
            --green: #10b981;
            --red: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
            font-family: "Inter", ui-sans-serif, system-ui, -apple-system;
            color: var(--text);
        }

        /* Navbar */
        header {
            height: 72px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 32px;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .brand h1 span {
            color: var(--accent);
        }

        /* POV Switcher */
        .pov-switch {
            display: flex;
            background: var(--panel-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .pov-btn {
            background: transparent;
            color: var(--grey);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pov-btn.active {
            background: var(--accent);
            color: #0f1115;
        }

        /* Main Layout */
        main {
            padding: 40px;
            max-width: 1200px;
            margin: 72px auto 0;
            /* Header height offset */
            width: 100%;
        }

        .view-header {
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .view-header h2 {
            margin: 0;
            font-size: 2rem;
            background: linear-gradient(135deg, var(--text), var(--grey));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .view-header p {
            margin: 8px 0 0;
            color: var(--grey);
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        /* Cards */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .card h3 {
            margin: 0 0 8px;
            font-size: 1.1rem;
            color: var(--text);
        }

        .card p {
            margin: 0 0 20px;
            font-size: 0.9rem;
            color: var(--grey);
            flex: 1;
        }

        /* Card Actions */
        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }

        .tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #1e293b;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #0f1115;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--grey);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .btn-outline:hover {
            border-color: var(--text);
            color: var(--text);
        }

        /* Status Badges */
        .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status.active {
            background: var(--green);
        }

        .status.pending {
            background: var(--accent);
        }

        .status.inactive {
            background: var(--grey);
        }

        /* Table structure for requests */
        .request-list {
            width: 100%;
            border-collapse: collapse;
        }

        .request-list th {
            text-align: left;
            color: var(--grey);
            font-size: 0.8rem;
            text-transform: uppercase;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .request-list td {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .request-list tr:last-child td {
            border-bottom: none;
        }

        /* Visibility Classes */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <h1>Bayanati <span>Security Enclave</span></h1>
        </div>

        <div class="pov-switch">
            <button class="pov-btn active" onclick="setPOV('bibf')">POV: BIBF</button>
            <button class="pov-btn" onclick="setPOV('sme')">POV: SME</button>
        </div>
    </header>

    <main>
        <!-- BIBF VIEW -->
        <div id="view-bibf" class="view active">
            <div class="view-header">
                <div>
                    <h2>Data Provider Dashboard</h2>
                    <p>Welcome, BIBF Admin. Manage your secure data assets and approvals.</p>
                </div>
                <button class="btn" onclick="triggerUpload()">+ Upload New Asset</button>
            </div>

            <h3 style="color: var(--grey); margin-bottom: 16px; font-size: 0.9rem; text-transform: uppercase;">Incoming
                Analysis Requests</h3>

            <div class="card" style="margin-bottom: 40px; padding: 0 24px;">
                <table class="request-list">
                    <thead>
                        <tr>
                            <th>Requester</th>
                            <th>Dataset</th>
                            <th>Purpose</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Local Tech SME</strong></td>
                            <td>Employment Trends 2025</td>
                            <td>Talent Gap Analysis</td>
                            <td><span class="status pending"></span>Pending Review</td>
                            <td><button class="btn" onclick="approveRequest(this)">Approve</button></td>
                        </tr>
                        <tr>
                            <td><strong>FinTech Corp</strong></td>
                            <td>Banking Sector Salaries</td>
                            <td>Compensation Benchmarking</td>
                            <td><span class="status active"></span>Enclave Running</td>
                            <td><button class="btn-outline">Monitor</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3 style="color: var(--grey); margin-bottom: 16px; font-size: 0.9rem; text-transform: uppercase;">Your
                Protected Assets</h3>
            <div class="grid">
                <div class="card">
                    <h3>Employment Trends 2025</h3>
                    <p>Occupational data across banking and insurance sectors. Highly sensitive.</p>
                    <div class="actions">
                        <span class="tag">Confidential</span>
                        <button class="btn-outline">Manage Policy</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Banking Sector Salaries</h3>
                    <p>Aggregated salary bands and compensation packages Q4 2025.</p>
                    <div class="actions">
                        <span class="tag">Restricted</span>
                        <button class="btn-outline">Manage Policy</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Graduate Placments</h3>
                    <p>University output vs industry hiring rate metrics.</p>
                    <div class="actions">
                        <span class="tag">Internal</span>
                        <button class="btn-outline">Manage Policy</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SME VIEW -->
        <div id="view-sme" class="view">
            <div class="view-header">
                <div>
                    <h2>SME Analysis Hub</h2>
                    <p>Browse available datasets and run secure computations.</p>
                </div>
            </div>

            <h3 style="color: var(--grey); margin-bottom: 16px; font-size: 0.9rem; text-transform: uppercase;">Available
                Data Marketplace</h3>

            <div class="grid">
                <div class="card">
                    <h3>BIBF Employment Trends</h3>
                    <p>Analyze skills gaps and hiring trends in the financial sector without accessing raw records.</p>
                    <div class="actions">
                        <span class="tag">Available</span>
                        <button class="btn" onclick="requestAccess(this)">Request Analysis</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Sector Salary Benchmarks</h3>
                    <p>Compute percentile rankings for your organization against industry standards.</p>
                    <div class="actions">
                        <span class="tag">Premium</span>
                        <button class="btn" onclick="requestAccess(this)">Request Analysis</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Consumer Spending Index</h3>
                    <p>Retail banking transaction aggregates categorized by merchant type.</p>
                    <div class="actions">
                        <span class="tag">Available</span>
                        <button class="btn" onclick="requestAccess(this)">Request Analysis</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Credit Risk Metadata</h3>
                    <p>Anonymized default rates by demographic segment.</p>
                    <div class="actions">
                        <span class="tag">Restricted</span>
                        <button class="btn-outline">Access Denied</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ENCLAVE VIEW (SME Analysis) -->
    <div id="view-enclave" class="view">
        <div class="view-header">
            <div>
                <h2><span style="color: var(--accent)">Secure Enclave</span>: Analysis Mode</h2>
                <p>Processing data in isolated environment. Raw data is never exposed.</p>
            </div>
            <button class="btn-outline" onclick="closeEnclave()">Exit Enclave</button>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 300px;">
            <!-- Left: Plot Area -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="actions" style="border:none; padding:0; margin-bottom:16px;">
                    <h3>Data Visualization</h3>
                    <div class="plot-controls" style="display:flex; gap:12px;">
                        <select id="xSelect">
                            <option>X Variable</option>
                        </select>
                        <select id="ySelect">
                            <option>Y Variable</option>
                        </select>
                        <button class="btn" onclick="generatePlot()">Generate Plot</button>
                    </div>
                </div>

                <div id="plotContainer"
                    style="min-height:300px; display:flex; align-items:center; justify-content:center; background:var(--panel-dark); border-radius:8px;">
                    <p style="color:var(--grey)">Select variables to generate density plot</p>
                </div>
            </div>

            <!-- Stats Area -->
            <div class="card"
                style="grid-column: 1 / -1; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                <div id="enclave-stat-rows">
                    <h4 style="color:var(--grey); margin:0;">Rows</h4>
                    <p style="font-size:1.5rem; font-weight:600; color:var(--text); margin:4px 0;">-</p>
                </div>
                <div id="enclave-stat-cols">
                    <h4 style="color:var(--grey); margin:0;">Columns</h4>
                    <p style="font-size:1.5rem; font-weight:600; color:var(--text); margin:4px 0;">-</p>
                </div>
                <div id="enclave-stat-features">
                    <h4 style="color:var(--grey); margin:0;">Numeric Features</h4>
                    <p style="font-size:1.5rem; font-weight:600; color:var(--text); margin:4px 0;">-</p>
                </div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h3>Feature Statistics</h3>
                <div id="featureList" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;"></div>
                <div id="featureStats"
                    style="margin-top:16px; padding:16px; background:var(--panel-dark); border-radius:8px; font-family:monospace; color:var(--grey);">
                    Select a feature above to view stats.
                </div>
            </div>
        </div>
    </div>
    </main>

    <!-- Hidden Upload Input -->
    <input type="file" id="uploadInput" accept=".csv" hidden onchange="handleUpload(this)" />

    <script>
        const API_BASE = "https://api.shabani05.com";
        let currentPOV = 'bibf';
        let currentSummary = null;
        let currentDataset = null;

        // init
        window.onload = () => {
            loadDataAssets();
        };

        function setPOV(role) {
            currentPOV = role;

            // Update Buttons
            document.querySelectorAll('.pov-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update Views
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(`view-${role}`).classList.add('active');

            // Dynamic Title Update
            document.querySelector('.brand span').textContent = role === 'bibf' ? 'Security Enclave' : 'Partner Portal';
        }

        function triggerUpload() {
            document.getElementById('uploadInput').click();
        }

        async function handleUpload(input) {
            if (!input.files[0]) return;
            const file = input.files[0];

            const formData = new FormData();
            formData.append('file', file);

            try {
                // Mock loading state on button (optional, but good UX)
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    alert('Asset Uploaded Successfully');
                    loadDataAssets(); // Refresh lists
                } else {
                    const txt = await res.text();
                    alert(`Upload failed: ${res.status} - ${txt}`);
                }
            } catch (e) {
                console.error(e);
                alert('Error uploading file');
            }

            input.value = ''; // Reset
        }

        async function loadDataAssets() {
            try {
                const res = await fetch(`${API_BASE}/files`);
                const data = await res.json();

                renderBIBFAssets(data.files);
                renderSMEAssets(data.files);
            } catch (e) {
                console.error("Failed to load files", e);
            }
        }

        function displayName(path) {
            return path.replace(/^\.\/files\//, "").replace(/\.csv$/i, "");
        }

        function renderBIBFAssets(files) {
            const container = document.querySelector('#view-bibf .grid');
            // Keep existing hardcoded examples or replace? User asked to "make it better" -> Let's append real ones or clear. 
            // Strategy: Clear and rebuild.
            container.innerHTML = '';

            files.forEach(file => {
                const name = displayName(file);
                const html = `
              <div class="card">
                <h3>${name}</h3>
                <p>Secure Data Asset stored in Enclave.</p>
                <div class="actions">
                  <span class="tag">Active</span>
                  <button class="btn-outline">Manage Policy</button>
                </div>
              </div>
             `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderSMEAssets(files) {
            const container = document.querySelector('#view-sme .grid');
            container.innerHTML = '';

            files.forEach(file => {
                const name = displayName(file);
                const html = `
              <div class="card">
                <h3>${name}</h3>
                <p>Available for secure analysis.</p>
                <div class="actions">
                  <span class="tag">Available</span>
                  <button class="btn" onclick="openEnclave('${file}')">Request Analysis</button>
                </div>
              </div>
             `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        async function openEnclave(path) {
            currentDataset = path;

            // Switch to Enclave View
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById('view-enclave').classList.add('active');

            // Init Analysis
            try {
                const res = await fetch(`${API_BASE}/summarize`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ path }),
                });

                currentSummary = await res.json();
                renderEnclaveStats(currentSummary);
            } catch (e) {
                alert('Failed to initialize enclave analysis');
                closeEnclave();
            }
        }

        function closeEnclave() {
            document.getElementById('view-enclave').classList.remove('active');
            // Go back to SME view
            document.getElementById('view-sme').classList.add('active');
        }

        function renderEnclaveStats(data) {
            // Top stats
            document.querySelector('#enclave-stat-rows p').textContent = data.rows;
            document.querySelector('#enclave-stat-cols p').textContent = data.columns.length;
            document.querySelector('#enclave-stat-features p').textContent = Object.keys(data.mean).length;

            // Feature List
            const list = document.getElementById('featureList');
            list.innerHTML = '';
            data.columns.forEach(col => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.style.cursor = 'pointer';
                tag.style.background = 'var(--panel-dark)';
                tag.style.border = '1px solid var(--border)';
                tag.textContent = col;
                tag.onclick = () => showFeatureStats(col);
                list.appendChild(tag);
            });

            // Selectors
            populateVariableSelectors(data.mean);
        }

        function showFeatureStats(col) {
            const mean = currentSummary.mean[col];
            const variance = currentSummary.variance[col];
            const box = document.getElementById('featureStats');

            if (mean === undefined) {
                box.innerHTML = `<strong>${col}</strong>: Non-numeric feature.`;
            } else {
                box.innerHTML = `
               <strong>${col}</strong><br/>
               Mean: <span style="color:var(--accent)">${mean.toFixed(4)}</span><br/>
               Variance: <span style="color:var(--primary)">${variance.toFixed(4)}</span>
             `;
            }
        }

        function populateVariableSelectors(numericVars) {
            const x = document.getElementById("xSelect");
            const y = document.getElementById("ySelect");

            x.innerHTML = '<option value="">X variable</option>';
            y.innerHTML = '<option value="">Y variable</option>';

            Object.keys(numericVars).forEach((col) => {
                const optX = document.createElement("option");
                optX.value = col;
                optX.textContent = col;
                x.appendChild(optX);

                const optY = document.createElement("option");
                optY.value = col;
                optY.textContent = col;
                y.appendChild(optY);
            });
        }

        async function generatePlot() {
            const path = currentDataset;
            const var1 = document.getElementById("xSelect").value;
            const var2 = document.getElementById("ySelect").value;

            if (!path || !var1 || !var2) return;

            const res = await fetch(`${API_BASE}/plot`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ path, var1, var2 }),
            });

            if (!res.ok) {
                document.getElementById("plotContainer").textContent = "Plot Failed";
                return;
            }

            const blob = await res.blob();
            const img = document.createElement("img");
            img.src = URL.createObjectURL(blob);
            img.style.maxWidth = "100%";
            img.style.maxHeight = "300px";

            const container = document.getElementById("plotContainer");
            container.innerHTML = "";
            container.appendChild(img);
        }

        // Keep mock approvals for BIBF view completeness if desired, 
        // but the assets part is now dynamic.
        function approveRequest(btn) {
            // Mock logic from before
            btn.textContent = "Initializing...";
            setTimeout(() => {
                btn.className = 'btn-outline';
                btn.textContent = 'Monitor';
            }, 1000);
        }
    </script>
</body>

</html>